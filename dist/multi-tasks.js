#!/usr/bin/env node

await (async () => {
  const { dirname } = await import("path");
  const { fileURLToPath } = await import("url");

  /**
   * Shim entry-point related paths.
   */
  if (typeof globalThis.__filename === "undefined") {
    globalThis.__filename = fileURLToPath(import.meta.url);
  }
  if (typeof globalThis.__dirname === "undefined") {
    globalThis.__dirname = dirname(globalThis.__filename);
  }
  /**
   * Shim require if needed.
   */
  if (typeof globalThis.require === "undefined") {
    const { default: module } = await import("module");
    globalThis.require = module.createRequire(import.meta.url);
  }
})();

var _=Object.create;var $=Object.defineProperty;var B=Object.getOwnPropertyDescriptor;var F=Object.getOwnPropertyNames;var N=Object.getPrototypeOf,G=Object.prototype.hasOwnProperty;var T=(s=>typeof require<"u"?require:typeof Proxy<"u"?new Proxy(s,{get:(e,t)=>(typeof require<"u"?require:e)[t]}):s)(function(s){if(typeof require<"u")return require.apply(this,arguments);throw Error('Dynamic require of "'+s+'" is not supported')});var M=(s,e)=>()=>(e||s((e={exports:{}}).exports,e),e.exports);var J=(s,e,t,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of F(e))!G.call(s,n)&&n!==t&&$(s,n,{get:()=>e[n],enumerable:!(r=B(e,n))||r.enumerable});return s};var R=(s,e,t)=>(t=s!=null?_(N(s)):{},J(e||!s||!s.__esModule?$(t,"default",{value:s,enumerable:!0}):t,s));var E=M((X,y)=>{"use strict";var v="\x1B",a=`${v}[`,U="\x07",f={to(s,e){return e?`${a}${e+1};${s+1}H`:`${a}${s+1}G`},move(s,e){let t="";return s<0?t+=`${a}${-s}D`:s>0&&(t+=`${a}${s}C`),e<0?t+=`${a}${-e}A`:e>0&&(t+=`${a}${e}B`),t},up:(s=1)=>`${a}${s}A`,down:(s=1)=>`${a}${s}B`,forward:(s=1)=>`${a}${s}C`,backward:(s=1)=>`${a}${s}D`,nextLine:(s=1)=>`${a}E`.repeat(s),prevLine:(s=1)=>`${a}F`.repeat(s),left:`${a}G`,hide:`${a}?25l`,show:`${a}?25h`,save:`${v}7`,restore:`${v}8`},W={up:(s=1)=>`${a}S`.repeat(s),down:(s=1)=>`${a}T`.repeat(s)},D={screen:`${a}2J`,up:(s=1)=>`${a}1J`.repeat(s),down:(s=1)=>`${a}J`.repeat(s),line:`${a}2K`,lineEnd:`${a}K`,lineStart:`${a}1K`,lines(s){let e="";for(let t=0;t<s;t++)e+=this.line+(t<s-1?f.up():"");return s&&(e+=f.left),e}};y.exports={cursor:f,scroll:W,erase:D,beep:U}});var P=M((Z,k)=>{var A=process.argv||[],b=process.env,j=!("NO_COLOR"in b||A.includes("--no-color"))&&("FORCE_COLOR"in b||A.includes("--color")||process.platform==="win32"||T!=null&&T("tty").isatty(1)&&b.TERM!=="dumb"||"CI"in b),K=(s,e,t=s)=>r=>{let n=""+r,i=n.indexOf(e,s.length);return~i?s+q(n,e,t,i)+e:s+n+e},q=(s,e,t,r)=>{let n="",i=0;do n+=s.substring(i,r)+t,i=r+e.length,r=s.indexOf(e,i);while(~r);return n+s.substring(i)},C=(s=j)=>{let e=s?K:()=>String;return{isColorSupported:s,reset:e("\x1B[0m","\x1B[0m"),bold:e("\x1B[1m","\x1B[22m","\x1B[22m\x1B[1m"),dim:e("\x1B[2m","\x1B[22m","\x1B[22m\x1B[2m"),italic:e("\x1B[3m","\x1B[23m"),underline:e("\x1B[4m","\x1B[24m"),inverse:e("\x1B[7m","\x1B[27m"),hidden:e("\x1B[8m","\x1B[28m"),strikethrough:e("\x1B[9m","\x1B[29m"),black:e("\x1B[30m","\x1B[39m"),red:e("\x1B[31m","\x1B[39m"),green:e("\x1B[32m","\x1B[39m"),yellow:e("\x1B[33m","\x1B[39m"),blue:e("\x1B[34m","\x1B[39m"),magenta:e("\x1B[35m","\x1B[39m"),cyan:e("\x1B[36m","\x1B[39m"),white:e("\x1B[37m","\x1B[39m"),gray:e("\x1B[90m","\x1B[39m"),bgBlack:e("\x1B[40m","\x1B[49m"),bgRed:e("\x1B[41m","\x1B[49m"),bgGreen:e("\x1B[42m","\x1B[49m"),bgYellow:e("\x1B[43m","\x1B[49m"),bgBlue:e("\x1B[44m","\x1B[49m"),bgMagenta:e("\x1B[45m","\x1B[49m"),bgCyan:e("\x1B[46m","\x1B[49m"),bgWhite:e("\x1B[47m","\x1B[49m")}};k.exports=C();k.exports.createColors=C});var p=R(E(),1),d=R(P(),1);import m from"node:process";function w(){return m.platform!=="win32"?m.env.TERM!=="linux":!!m.env.WT_SESSION||!!m.env.TERMINUS_SUBLIME||m.env.ConEmuTask==="{cmd::Cmder}"||m.env.TERM_PROGRAM==="Terminus-Sublime"||m.env.TERM_PROGRAM==="vscode"||m.env.TERM==="xterm-256color"||m.env.TERM==="alacritty"||m.env.TERMINAL_EMULATOR==="JetBrains-JediTerm"}var L=w(),g=(s,e)=>L?s:e,re=g("\u25C6","*"),z=g("\u25A0","x"),H=g("\u25B2","x"),V=g("\u25C7","o"),I=L?["\u25D2","\u25D0","\u25D3","\u25D1"]:["\u2022","o","O","0"],u=class s{static instance;tasks;spinners;interval;previousRenderedLines;isRunning;taskPromises;resolveAllTasks;stream;rows;abortController;constructor(e=process.stdout){this.tasks=[],this.spinners=new Map,this.interval=null,this.previousRenderedLines=0,this.isRunning=!1,this.taskPromises=[],this.resolveAllTasks=null,this.stream=e,this.rows=e.rows||0,this.abortController=new AbortController,e.on("resize",()=>{this.rows=e.rows||0})}static getInstance(){return s.instance||(s.instance=new s),s.instance}run(){this.isRunning=!0,this.stream.write(`
`),this.render(),this.interval=setInterval(()=>this.render(),80);let e=new Promise(t=>{this.resolveAllTasks=t,this.tasks.forEach((r,n)=>{let i=r.index!==void 0?r.index:n;this.taskPromises.push(this.executeTask(r,i))})});return e.finally(()=>{this.stop()}),process.on("SIGINT",()=>{this.stop()}),e}stop(){this.isRunning&&(this.cancelPendingTasks(),this.render(),this.isRunning=!1,this.abortController.abort(),this.interval&&clearInterval(this.interval),this.stream.write(`
`),this.resolveAllTasks&&this.resolveAllTasks())}cancelPendingTasks(){this.spinners.forEach((e,t)=>{e.status==="pending"&&(e.status="cancelled",e.message+=" (Cancelled)")})}update(e,t){let r=this.spinners.get(e);r&&(r.message=t)}add(...e){e.forEach(t=>{if(t.disabled)return;let r=t.index!==void 0?t.index:this.spinners.size;this.spinners.set(r,{frame:0,message:t.initialMessage,status:"pending",statusSymbol:t.statusSymbol}),this.tasks.push(t),this.isRunning&&this.taskPromises.push(this.executeTask(t,r))})}hasPendingTasks(){return Array.from(this.spinners.values()).some(e=>e.status==="pending")}async executeTask(e,t){let r=i=>{this.update(t,i)},n=this.spinners.get(t);if(n){try{await e.task(r,this.abortController.signal),this.abortController.signal.aborted||(n.status="success")}catch{n.status="error"}!this.hasPendingTasks()&&this.resolveAllTasks&&(this.render(),this.resolveAllTasks())}}render(){if(!this.isRunning)return;let t=Array.from(this.spinners.entries()).sort(([n],[i])=>n-i).map(([n,i])=>{let o=d.default.magenta(I[i.frame]);return i.frame=(i.frame+1)%I.length,`|
${i.statusSymbol?i.statusSymbol:i.status==="success"?d.default.green(V):i.status==="error"?d.default.red(H):i.status==="cancelled"?d.default.yellow(z):o}  ${i.message}`}).join(`
`);this.previousRenderedLines>0&&this.stream.write(p.erase.lines(this.previousRenderedLines)),this.stream.write(p.cursor.to(0,0));let r=t.split(`
`).length;r<=this.rows?this.stream.write(t):this.stream.write(t.split(`
`).slice(r-this.rows).join(`
`)),this.previousRenderedLines=r}},h=class{initialMessage;updateFn=()=>{};signal;close;fail;constructor(e){this.initialMessage=e??""}task=async(e,t)=>{if(this.updateFn=e,this.signal=t,t?.aborted)return Promise.resolve("Aborted");let r=()=>{this.close("Aborted")};t.addEventListener("abort",r,{once:!0});let n=new Promise((i,o)=>{if(t.aborted){i();return}this.close=i,this.fail=o});return n.finally(()=>{t.removeEventListener("abort",r)}),n}},O=s=>{u.getInstance().add({initialMessage:s,task:async()=>{}})};var x=class extends h{text="";initialMessage="Stream Task";stream(e){this.text+=e,this.updateFn(this.text)}};function S(s){O(s)}S("Task 1");S("Task 2");S("Task 3");function l(s,e){return e?.aborted?Promise.resolve():new Promise((t,r)=>{let n=setTimeout(t,s*1e3);e&&e.addEventListener("abort",()=>{clearTimeout(n),t()})})}function Y(){let s=new x("Stream Task 2"),e=[{initialMessage:"Task 1",index:1e3,task:async(i,o)=>{await l(2,o),i("Task 1 is halfway done"),await l(2,o),i("Task 1 completed successfully")}},{initialMessage:"Task 2: Empty Task",task:async i=>{}},{initialMessage:"Task Disabled",disabled:!0,task:async(i,o)=>{await l(1,o),i("This task should not run"),await l(2,o),i("Disabled Task finished")}},s];s.stream("Stream Task 2 is running");let t=u.getInstance();t.add(...e);let r=t.run();t.add({initialMessage:"Task 3 with custom symbol",statusSymbol:"#",task:async(i,o)=>{await l(1,o),i("Task 3 is running");let c=new x("Stream Task 3");t.add(c),c.stream("Stream Task 3 is running"),await l(2,o),c.close("Stream Task 3 completed"),i("Task 3 completed")}});let n=setInterval(()=>{s.stream(`
Lorem ipsum dolor sit amet, consectetur adipiscing elit.`)},500);setTimeout(()=>{clearInterval(n),s.close("Finished")},3e3),setTimeout(()=>{t.add({initialMessage:"Task 4 with failure",task:async(i,o)=>{throw await l(1,o),i("Task with failure is executing"),await l(1,o),new Error("Random error")}})},1e3),setTimeout(()=>{t.add({initialMessage:"Task 5 added late",task:async(i,o)=>{await l(1,o),i("Task 5 is executing"),await l(1,o),i("Task 5 is done")}})},2500),setTimeout(()=>{t.add({initialMessage:"Task Too late (Should not be added)",task:async(i,o)=>{await l(1,o),i("This task should not run")}})},6e3),r.then(()=>{console.log(`
All tasks completed!`)}).catch(i=>{console.error(`
An error occurred:`,i)})}Y();
